<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Wimmelbild - Plan:g</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#769b60" />

  <script src="./openseadragon/openseadragon.min.js"></script>
  <script src="detect-browser.js"></script>
  <script>
    const info = (typeof getBrowser === "function" && getBrowser()) || {};
    if (["Microsoft Edge","Safari","Internet Explorer"].includes(info.browser)) {
      window.location = "index_ie.html";
    }
  </script>

  <style>
    @font-face{
      font-family:"circular";
      src:url("src/lineto-circular-book.woff") format("woff");
      font-weight:normal;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    html,body{height:100%}
    body{
      font-family:"circular",Arial,sans-serif;
      background:#f3f3f3;
      overflow:hidden; /* Bühne skaliert, keine Scrollbars */
      padding:
        max(env(safe-area-inset-top),0px)
        max(env(safe-area-inset-right),0px)
        max(env(safe-area-inset-bottom),0px)
        max(env(safe-area-inset-left),0px);
    }

    /* === feste Desktop-Bühne, die wir skaliert & zentriert anzeigen === */
    .stage-wrap{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
      background:#f3f3f3;
    }

    /* „Bühne“ in Desktop-Maßen (wird via transform skaliert/verschoben) */
    .stage{
      position:absolute; /* wichtig für translate() */
      width: 1340px;     /* BASE_LEFT_WIDTH + CIRCLE_DIAMETER */
      height: 820px;     /* Basis-Höhe */
      left: 0; top: 0;
      transform-origin: top left;
      will-change: transform;
    }

    /* Linke Spalte */
    .left{
      position:absolute;
      top:51px; left:22px;
      width: 520px;      /* BASE_LEFT_WIDTH */
      z-index:10;
    }
    .logo{ width:250px; padding-bottom:24px; }
    .claim{ font-size:28px; line-height:1.28; margin-top:8px; }

    .ctas{ display:flex; flex-wrap:wrap; gap:12px; margin-top:36px; }
    .cta{
      max-width:230px; background:#789f40; color:#fff; text-decoration:none;
      text-transform:uppercase; font-weight:bold; font-size:16px;
      padding:14px; display:flex; align-items:center; justify-content:center;
      transition:background-color .25s;
    }
    .cta:active,.cta:hover{ background:#870184; }

    .impressum{
      position:absolute; left:22px; bottom:18px; font-size:14px; line-height:1.4;
    }
    .language{ display:flex; gap:14px; margin-bottom:6px; }
    .flag{ width:28px; height:20px; background-size:cover; }
    .flag.de{ background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/at.svg"); }
    .flag.en{ background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/gb.svg"); }
    .text-link{ color:#789f40; text-decoration:none; }

    /* Rechte Spalte: runder Viewer */
    .right{
      position:absolute;
      top: 0;
      left: 520px;      /* exakt neben der linken Spalte */
      width: 820px;     /* CIRCLE_DIAMETER */
      height: 820px;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none; /* Container selbst nicht klickbar */
    }
    #myContainer{
      width: 820px; height: 820px;
      background:#769b60;
      clip-path: circle(50% at 50% 50%);
      -webkit-clip-path: circle(50% at 50% 50%);
      overflow:hidden;
      pointer-events:auto; /* nur der Viewer interaktiv */
    }

    /* Hotspots & Popup */
    .hotspot-overlay{
      width:14px;height:14px;border-radius:50%;
      background-size:cover;background-repeat:no-repeat;
      box-shadow:0 2px 4px rgba(0,0,0,.3);
    }
    .popup{
      max-width:620px; max-height:60vh; overflow:hidden;
      border-radius:8px; background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.3);
    }
    .popup img{ display:block; width:100%; height:auto; }
  </style>
</head>
<body>
  <div class="stage-wrap">
    <div id="stage" class="stage" aria-hidden="false">
      <div class="left">
        <a href="https://plan-g.at/ueber-uns" target="_blank"><img src="img/logo.png" class="logo" alt="plan:g"></a>
        <h1 class="claim">
          Die Welt ist ziemlich klein,<br>
          Gesundheit ziemlich komplex:<br>
          Viel Spaß beim Entdecken.
        </h1>
        <div class="ctas">
          <a class="cta" href="https://plan-g.at/fachthemen/medizin-und-eza" target="_blank">Dieses Poster</a>
          <a class="cta" href="https://plan-g.at/projekte/alle-projekte" target="_blank">Unsere Arbeit</a>
          <a class="cta" href="https://plan-g.at/news-events/informiert-bleiben" target="_blank">Informiert bleiben</a>
        </div>
      </div>

      <div class="right">
        <div id="myContainer"></div>
      </div>

      <div class="impressum">
        <div class="language">
          <a href="https://weltgesundheit.org" class="text-link" title="Deutsch"><div class="flag de"></div></a>
          <a href="https://weltgesundheit.org/en/" class="text-link" title="English"><div class="flag en"></div></a>
        </div>
        <p>Illustration: Alice Ruzzettu</p>
        <a href="http://plan-g.at/impressum" target="_blank" class="text-link">Impressum</a>
      </div>
    </div>
  </div>

  <script>
    /* ===== 1) Bühnenskalierung & Zentrierung ===== */
    const BASE = {
      LEFT_WIDTH: 520,           // px
      CIRCLE: 820,               // Durchmesser
      STAGE_W: 520 + 820,        // 1340
      STAGE_H: 820               // 820
    };

    const stage = document.getElementById('stage');

    // 'contain' = komplett sichtbar; 'cover' = füllt Screen (kann außerhalb liegen)
    const FILL_MODE = 'contain';

    function fitStageToViewport(){
      const cs = getComputedStyle(document.body);
      const vw = window.innerWidth  - (parseInt(cs.paddingLeft) + parseInt(cs.paddingRight));
      const vh = window.innerHeight - (parseInt(cs.paddingTop)  + parseInt(cs.paddingBottom));

      const sx = vw / BASE.STAGE_W;
      const sy = vh / BASE.STAGE_H;
      const scale = (FILL_MODE === 'cover') ? Math.max(sx, sy) : Math.min(sx, sy, 1);

      const usedW = BASE.STAGE_W * scale;
      const usedH = BASE.STAGE_H * scale;
      const offsetX = Math.max(0, (vw - usedW) / 2);
      const offsetY = Math.max(0, (vh - usedH) / 2);

      stage.style.transformOrigin = 'top left';
      stage.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
    }

    window.addEventListener('resize', () => { fitStageToViewport(); viewer?.forceRedraw(); });
    window.addEventListener('orientationchange', () => setTimeout(() => { fitStageToViewport(); viewer?.forceRedraw(); }, 100));
    fitStageToViewport();

    /* ===== 2) OpenSeadragon ===== */
    const viewer = OpenSeadragon({
      id: "myContainer",
      prefixUrl: "openseadragon/images/",
      tileSources: {
        type: "image",
        width: 5787,
        height: 7722,
        url: "./img/wimmelbildfinal.jpg",
        minLevel: 0,
        maxLevel: 5,
        buildPyramid: true
      },
      showNavigator: false,
      showNavigationControl: false,
      defaultZoomLevel: 0,
      gestureSettingsMouse: { clickToZoom:true, dblClickToZoom:true, pinchToZoom:true },
      gestureSettingsTouch: { clickToZoom:true, dblClickToZoom:true, pinchToZoom:true },
      constrainDuringPan: true,
      maxZoomPixelRatio: 2,
      minZoomImageRatio: 0.5,
      maxZoomImageRatio: 3
    });

    // Beim Öffnen: Bild so setzen, dass es den Kreis gut füllt
    viewer.addHandler('open', () => {
      viewer.viewport.fitVertically();
      setTimeout(() => viewer.viewport.zoomBy(1.06), 60);
    });

    /* ===== 3) Hotspots ===== */
    function loadHotspots(xmlFile){
      fetch(xmlFile)
        .then(r => r.text())
        .then(str => (new DOMParser()).parseFromString(str, "text/xml"))
        .then(xml => {
          const spots = xml.getElementsByTagName("HOTSPOT");
          for (let i=0;i<spots.length;i++){
            const x = parseFloat(spots[i].getAttribute("X"));
            const y = parseFloat(spots[i].getAttribute("Y"));
            const id = spots[i].getAttribute("ID");
            const popupImage = spots[i].getAttribute("POPUP");
            addOverlay(x, y, id, "./Assets/button-wim.png", popupImage);
          }
        })
        .catch(err => console.error("Error loading XML:", err));
    }

    function addOverlay(x, y, id, icon, popupImage){
      const normalizedX = (x * (5787 / 14344)) / 5787;
      const normalizedY = (y * (7722 / 19140)) / 7722 * 1.3348;

      const el = document.createElement("div");
      el.className = "hotspot-overlay";
      el.style.backgroundImage = `url(${icon})`;

      const handler = (e) => { e.preventDefault(); togglePopup(id, normalizedX, normalizedY, popupImage); };
      el.addEventListener('touchstart', handler, { passive:false });
      el.addEventListener('click', handler);

      // tatsächlich zum Viewer hinzufügen
      viewer.addOverlay({
        element: el,
        location: new OpenSeadragon.Point(normalizedX, normalizedY),
        placement: OpenSeadragon.OverlayPlacement.CENTER
      });
    }

    function togglePopup(id, x, y, popupImage){
      const ex = document.getElementById(`popup-${id}`);
      if (ex){ ex.remove(); return; }

      const popup = document.createElement("div");
      popup.className = "popup";
      popup.id = `popup-${id}`;
      popup.innerHTML = `<img src="${popupImage}" alt="Popup ${id}">`;

      viewer.addOverlay({
        element: popup,
        location: new OpenSeadragon.Point(x, y),
        placement: OpenSeadragon.OverlayPlacement.BOTTOM
      });

      setTimeout(() => document.getElementById(`popup-${id}`)?.remove(), 5000);
    }

    loadHotspots("./src/hotspots.xml");
  </script>
</body>
</html>
