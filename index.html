<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Wimmelbild – Plan:g</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  
  <!-- OpenSeadragon -->
  <script src="./openseadragon/openseadragon.min.js"></script>

  <style>
    /* ========= Design Tokens ========= */
    :root{
      --green:#789f40;         /* CTA/Text-Link */
      --green-dark:#769b60;    /* Kreis/Canvas BG */
      --accent:#870184;        /* Hover */
      --bg:#f3f3f3;            /* Page BG */
      --pad: clamp(14px, 4vw, 20px);
      --hotspot-color:#ffffff;
      --hotspot-border:rgba(0,0,0,.25);
      --text:#111;
    }

    /* ========= Base ========= */
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    a{ color:inherit; text-decoration:none; }

    /* ========= Header ========= */
    .m-header{ padding: calc(env(safe-area-inset-top) + 14px) var(--pad) 16px; }
    .m-header__logo{ width: clamp(160px, 28vw, 260px); height:auto; display:block; }

    .m-ctas{ margin-top:14px; display:grid; gap:12px; max-width:720px; grid-template-columns: 1fr; }
    .cta{ font-weight:700; text-transform:uppercase; font-size:clamp(13px,3.2vw,16px); background:var(--green); color:#fff; padding:12px 16px; border-radius:14px; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,.12); transition:transform .08s ease, background .2s ease; }
    .cta.square{ border-radius:0; }
    .cta:active{ transform:scale(.98); }
    .cta:hover{ background:var(--accent); }

    /* Desktop: drei nebeneinander */
    @media (min-width: 900px){ .m-ctas{ grid-template-columns: repeat(3, minmax(0,1fr)); } }

    /* ========= Headline ========= */
    .m-headline{ padding:12px var(--pad) 0; margin-bottom: clamp(14px, 4vw, 26px); }
    .m-headline h1{ margin:0; font-size: clamp(18px, 3.6vw, 28px); line-height:1.28; }

    /* ========= Viewer/Kreis ========= */
    .circle-wrap{ padding: clamp(22px, 4.8vw, 32px) var(--pad) clamp(14px, 3.6vw, 24px); display:grid; place-items:center; }
    .circle{ width:min(92vw, 1100px); aspect-ratio:1/1; border-radius:0; clip-path:circle(50% at 50% 50%); background:var(--green-dark); overflow:hidden; position:relative; box-shadow:0 8px 28px rgba(0,0,0,.18); }
    /* Desktop Hover-Reveal ähnlich Original */
    @media (hover:hover) and (pointer:fine){
      .circle{ transition: clip-path 900ms ease, border-radius 900ms ease; }
      .circle:hover{ clip-path:circle(100% at 50% 50%); border-radius:0; }
    }

    /* Vollbild-Zustände */
    .circle.is-fullscreen{ clip-path:none; border-radius:0; width:100vw; height:100vh; background:var(--green-dark); }
    .pseudo-fs .circle{ clip-path:none!important; border-radius:0!important; position:fixed!important; inset:0!important; width:100vw!important; height:100vh!important; background:var(--green-dark)!important; z-index:998!important; }

    /* OSD-Container */
    #myContainer{ position:absolute; inset:0; width:100%; height:100%; background:transparent; touch-action:manipulation; z-index:1; }

    /* Herz oben rechts */
    .heart-cta{ position:absolute; top:12px; right:12px; z-index:1000; display:block; opacity:1; }
    .heart-cta img{ display:block; width: clamp(36px, 6vw, 72px); height:auto; }

    /* ========= Hotspots ========= */
    .hotspot-overlay{ width:20px; height:20px; background:var(--hotspot-color); background-size:contain; background-position:center; background-repeat:no-repeat; border:1px solid var(--hotspot-border); border-radius:0; box-shadow:0 1px 4px rgba(0,0,0,.35); cursor:pointer; touch-action:manipulation; opacity:1; z-index:2; transition:opacity .15s ease; -webkit-tap-highlight-color: rgba(0,0,0,0); }
    .hotspot-overlay.has-icon{ appearance:none; -webkit-appearance:none; padding:0; background-color:transparent !important; border:0 !important; box-shadow:none !important; outline:none !important; border-radius:9999px !important; overflow:hidden; background-clip:padding-box; }
    .hotspot-overlay.has-icon:focus, .hotspot-overlay.has-icon:focus-visible, .hotspot-overlay.has-icon:active{ outline:none !important; background-color:transparent !important; border:0 !important; box-shadow:none !important; }
    .hotspot-overlay.is-hidden{ opacity:0; pointer-events:none; }
    .circle.is-fullscreen .hotspot-overlay, .pseudo-fs .hotspot-overlay{ opacity:1; border-width:1px; box-shadow:0 1px 3px rgba(0,0,0,.3); }

    /* ========= Popup (nur Bild) ========= */
    .popup{ background:transparent; padding:0; border:none; border-radius:0; box-shadow:none; overflow:visible; max-width:90vw; max-height:85vh; z-index:3; }
    .circle.is-fullscreen .popup{ max-width:90vw; max-height:85vh; }
    .popup img{ display:block; width:auto; height:auto; max-width:100%; max-height:100%; object-fit:contain; border-radius:0; }

    /* ========= Footer ========= */
    .m-footer{ padding:12px var(--pad) calc(env(safe-area-inset-bottom) + 18px); display:grid; gap:8px; }
    .language{ display:flex; gap:12px; align-items:center; }
    .flag{ width:28px; height:21px; background-size:cover; background-repeat:no-repeat; border-radius:3px; box-shadow:0 1px 3px rgba(0,0,0,.2); }
    .flag.de{ background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/at.svg"); }
    .flag.en{ background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/gb.svg"); }
    .text-link{ color:var(--green); }
    .m-footer p{ margin:0; font-size:14px; }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="m-header">
    <img src="img/logo.png" alt="Plan:g – logo" class="m-header__logo" />
    <div class="m-ctas">
      <a href="https://plan-g.at/fachthemen/medizin-und-eza" target="_blank" rel="noopener" class="cta square">Dieses Poster</a>
      <a href="https://plan-g.at/projekte/alle-projekte" target="_blank" rel="noopener" class="cta square">Unsere Arbeit</a>
      <a href="https://plan-g.at/news-events/informiert-bleiben" target="_blank" rel="noopener" class="cta square">Informiert bleiben</a>
    </div>
  </header>

  <!-- Headline -->
  <section class="m-headline">
    <h1>
      Die Welt ist ziemlich klein,<br />
      Gesundheit ziemlich komplex:<br />
      Viel Spaß beim Entdecken.
    </h1>
  </section>

  <!-- Viewer Section -->
  <section class="circle-wrap" aria-label="Interaktives Wimmelbild">
    <div class="circle" id="circle">
      <!-- Viewer Root -->
      <div id="myContainer" role="application" aria-label="Wimmelbild Viewer"></div>

      <!-- Herz oben rechts (Link) -->
      <a class="heart-cta" href="https://plan-g.at/ueber-uns" target="_blank" rel="noopener" aria-label="Über uns">
        <img src="img/signet_bunt.png" alt="" />
      </a>
    </div>
  </section>

  <!-- Footer / Impressum -->
  <footer class="m-footer">
    <div class="language">
      <a href="https://weltgesundheit.org" class="text-link" aria-label="Deutsch"><div class="flag de" title="Deutsch"></div></a>
      <a href="https://weltgesundheit.org/en/" class="text-link" aria-label="English"><div class="flag en" title="English"></div></a>
    </div>
    <p>Illustration: Alice Ruzzettu</p>
    <a href="http://plan-g.at/impressum" class="text-link" target="_blank" rel="noopener">Impressum</a>
  </footer>

  <!-- Matomo (aus eurer Desktop-Version übernommen) -->
  <script>
    var _paq = window._paq = window._paq || [];
    _paq.push(["trackPageView"]);
    _paq.push(["enableLinkTracking"]);
    (function() {
      var u = "https://www.plan-g.at/sub/piwik/";
      _paq.push(["setTrackerUrl", u + "piwik.php"]);
      _paq.push(["setSiteId", "4"]);
      var d = document, g = d.createElement("script"), s = d.getElementsByTagName("script")[0];
      g.type = "text/javascript"; g.async = true; g.defer = true; g.src = u + "piwik.js"; s.parentNode.insertBefore(g, s);
    })();
  </script>

  <!-- App / Viewer Logic -->
  <script>
    /* ====== Pfade ====== */
    const ASSETS_BASE = "./Assets";
    const ICON_DEFAULT = `${ASSETS_BASE}/button-wim.png`;
    const POPUPS_DIRS = [`${ASSETS_BASE}/popups`, `${ASSETS_BASE}/popups-2`];

    /* ====== OpenSeadragon ====== */
    const viewer = OpenSeadragon({
      id: "myContainer",
      prefixUrl: "openseadragon/images/",
      tileSources: {
        type: "image",
        width: 5787,
        height: 7722,
        url: "./img/wimmelbildfinal.jpg",
        minLevel: 0,
        maxLevel: 5,
        buildPyramid: true
      },
      showNavigator: true,              // Desktop-Default
      navigatorPosition: "TOP_RIGHT",
      showNavigationControl: true,
      autoHideControls: true,
      defaultZoomLevel: 0,
      blendTime: 0.12,
      animationTime: 0.85,
      springStiffness: 6.5,
      zoomPerClick: 1.22,
      zoomPerScroll: 1.14,
      visibilityRatio: 0.95,
      constrainDuringPan: true,
      minZoomImageRatio: 1,
      maxZoomPixelRatio: 2.0,
      immediateRender: true
    });

    // Nach dem Öffnen auf Home zoomen, damit der Bildausschnitt dem Original ähnelt
    viewer.addHandler('open', () => { viewer.viewport.goHome(true); applyHotspotScale(); hookOsdFullPageButton(); updateNavigatorVisibility(); });

    // Navigator mobil ausblenden
    function updateNavigatorVisibility(){
      const isDesktop = window.matchMedia('(min-width: 1024px)').matches;
      if (viewer.navigator) viewer.navigator.setVisible(isDesktop);
    }
    window.addEventListener('resize', updateNavigatorVisibility);

    /* ====== DOM-Refs ====== */
    const circleEl = document.getElementById("circle");
    const containerEl = document.getElementById("myContainer");

    /* ====== Eingabemedien ====== */
    const IS_POINTER_FINE = window.matchMedia('(pointer:fine)').matches; // Maus/Desktop

    /* ====== Größen/Koordinaten ====== */
    const SOURCE_W = 5787, SOURCE_H = 7722;
    const AUTHOR_W = 14344, AUTHOR_H = 19140;
    const Y_EXTRA_SCALE = 1.3348; // wie Original

    function normalizeXY(xAuthor, yAuthor) {
      const nx = (xAuthor * (SOURCE_W / AUTHOR_W)) / SOURCE_W;
      const ny = (yAuthor * (SOURCE_H / AUTHOR_H)) / SOURCE_H * Y_EXTRA_SCALE;
      return { nx, ny };
    }

    /* ====== Responsive Hotspot-Größe ====== */
    function getHotspotSizeParams(){
      if (window.matchMedia("(max-width: 640px)").matches) return { BASE: 14, MIN: 10, MAX: 18 };
      return { BASE: 20, MIN: 14, MAX: 24 };
    }

    function applyHotspotScale(){
      const { BASE, MIN, MAX } = getHotspotSizeParams();
      const z = viewer.viewport.getZoom(true);
      const isFs = (document.fullscreenElement === circleEl) || document.body.classList.contains("pseudo-fs");
      const fs = isFs ? 0.98 : 1.0;
      const size = Math.max(MIN, Math.min(MAX, BASE * fs * (0.90 + (z - 1) * 0.12)));
      document.querySelectorAll(".hotspot-overlay").forEach(el => { el.style.width = `${size}px`; el.style.height = `${size}px`; });
    }

    viewer.addHandler("zoom", applyHotspotScale);
    viewer.addHandler("resize", applyHotspotScale);

    /* ====== Vollbild-Logik: nur auf Touch-Geräten erzwingen ====== */
    function supportsFullscreen(){ return !!(circleEl.requestFullscreen || circleEl.webkitRequestFullscreen || circleEl.msRequestFullscreen); }
    function enterFullscreen(){ if (circleEl.requestFullscreen) return circleEl.requestFullscreen(); if (circleEl.webkitRequestFullscreen) return circleEl.webkitRequestFullscreen(); if (circleEl.msRequestFullscreen) return circleEl.msRequestFullscreen(); }
    function exitFullscreen(){ if (document.exitFullscreen) return document.exitFullscreen(); if (document.webkitExitFullscreen) return document.webkitExitFullscreen(); if (document.msExitFullscreen) return document.msExitFullscreen(); }
    function setFullscreenClasses(isFs){ circleEl.classList.toggle("is-fullscreen", isFs); if (!supportsFullscreen()){ document.body.classList.toggle("pseudo-fs", isFs); } }
    function updatePanBounds(isFs){ if (isFs || document.body.classList.contains("pseudo-fs")){ viewer.constrainDuringPan = false; viewer.viewport.setVisibilityRatio(0.2); viewer.minZoomImageRatio = 0.8; } else { viewer.constrainDuringPan = true; viewer.viewport.setVisibilityRatio(0.95); viewer.minZoomImageRatio = 1; } }

    document.addEventListener("fullscreenchange", () => { const isFs = document.fullscreenElement === circleEl; setFullscreenClasses(isFs); updatePanBounds(isFs); applyHotspotScale(); });
    document.addEventListener("webkitfullscreenchange", () => { const isFs = document.webkitFullscreenElement === circleEl; setFullscreenClasses(isFs); updatePanBounds(isFs); applyHotspotScale(); });

    // Nur auf Touch: Erstklick ⇒ Vollbild
    containerEl.addEventListener("touchend", async (e) => {
      if (e.touches && e.touches.length === 0){
        const alreadyFs = (document.fullscreenElement === circleEl) || document.body.classList.contains("pseudo-fs");
        if (!alreadyFs){ e.preventDefault(); await ensureFullscreenIfNeeded(); }
      }
    }, { passive: false });
    // Desktop-Klick: kein Vollbild erzwungen (wie Original)

    function ensureFullscreenIfNeeded(){
      if (IS_POINTER_FINE) return Promise.resolve(); // Desktop: nie erzwingen
      const alreadyFs = (document.fullscreenElement === circleEl) || document.body.classList.contains("pseudo-fs");
      if (alreadyFs) return Promise.resolve();
      if (supportsFullscreen()){
        return new Promise((resolve) => { const onChange = () => { document.removeEventListener("fullscreenchange", onChange); resolve(); }; document.addEventListener("fullscreenchange", onChange); enterFullscreen(); });
      }
      return new Promise((resolve) => { setFullscreenClasses(true); updatePanBounds(true); resolve(); });
    }

    /* === Fullscreen-Button robust toggeln === */
    function hookOsdFullPageButton(){
      const root = viewer.container || document.getElementById("myContainer");
      if (!root) return;
      const btn = root.querySelector('.openseadragon-full-page, .openseadragon-full-screen, [title*="Full"], [title*="Voll"], [title*="page"]');
      if (!btn || btn.__pgHooked) return;
      btn.__pgHooked = true;
      const handler = (e) => {
        e.preventDefault?.(); e.stopPropagation?.(); e.stopImmediatePropagation?.();
        const inFs = (document.fullscreenElement === circleEl) || document.body.classList.contains("pseudo-fs");
        if (inFs){ if (supportsFullscreen()) { exitFullscreen(); } else { setFullscreenClasses(false); updatePanBounds(false); applyHotspotScale(); } }
        else { ensureFullscreenIfNeeded().then(() => { applyHotspotScale(); }); }
      };
      const optsTouch = { capture: true, passive: false };
      const optsPointer = { capture: true };
      btn.addEventListener("touchstart", handler, optsTouch);
      btn.addEventListener("touchend", handler, optsTouch);
      btn.addEventListener("pointerup", handler, optsPointer);
      btn.addEventListener("click", handler, optsPointer);
    }

    /* ====== Popups/Hotspots ====== */
    let openPopupId = null;
    const popupTimers = new Map(); // id -> timeout

    function addOverlay(x, y, id, iconUrl, popupImage, popupText, popupTitle, colorValue, offsetX = 0, offsetY = 0) {
      const { nx, ny } = normalizeXY(x, y);
      const overlay = document.createElement("button");
      overlay.className = "hotspot-overlay";
      overlay.type = "button";
      overlay.setAttribute("aria-label", popupTitle || popupText || `Hotspot ${id}`);
      overlay.setAttribute("data-id", id);

      const finalIcon = iconUrl || ICON_DEFAULT;
      if (finalIcon) { overlay.classList.add("has-icon"); overlay.style.backgroundImage = `url("${finalIcon}")`; }
      else if (colorValue) { overlay.style.setProperty("--hotspot-color", colorValue); }

      // DESKTOP (Maus): Hover wie im Original
      if (IS_POINTER_FINE){
        overlay.addEventListener('mouseenter', () => { maybeOpenPopup(id, nx, ny, popupImage, popupText, popupTitle, overlay, false, offsetX, offsetY, /*hideDot*/ false); });
        overlay.addEventListener('mouseleave', () => { closePopup(id); });
      } else {
        // TOUCH: Tap zum Öffnen/Schließen + fokussieren
        const open = async (e) => { e.stopPropagation(); e.preventDefault?.(); await handleHotspotTap(nx, ny, id, popupImage, popupText, popupTitle, overlay, offsetX, offsetY); };
        overlay.addEventListener("touchend", open, { passive: false });
        overlay.addEventListener("click", open, { passive: true });
      }

      viewer.addOverlay({ element: overlay, location: new OpenSeadragon.Point(nx, ny), placement: OpenSeadragon.OverlayPlacement.CENTER });
    }

    async function handleHotspotTap(nx, ny, id, popupImage, popupText, popupTitle, overlayEl, offsetX = 0, offsetY = 0){
      await ensureFullscreenIfNeeded();
      focusOn(nx, ny, 1.6);
      if (openPopupId === id) { closePopup(id); return; }
      maybeOpenPopup(id, nx, ny, popupImage, popupText, popupTitle, overlayEl, true, offsetX, offsetY, /*hideDot*/ true);
    }

    function resolvePopupSrc(name){ if (!name) return null; if (name.includes("/")) return name; return `${POPUPS_DIRS[0]}/${name}`; }

    // Nur Bild rendern (wie mobile Version) – hideDot konfigurierbar
    function maybeOpenPopup(id, x, y, popupImage, popupText, popupTitle, overlayEl, closeOthers = false, offsetX = 0, offsetY = 0, hideDot = true){
      if (closeOthers && openPopupId && openPopupId !== id) closePopup(openPopupId);
      if (document.getElementById(`popup-${id}`)) return;

      if (overlayEl && hideDot) overlayEl.classList.add("is-hidden");

      const imgSrc = resolvePopupSrc(popupImage);
      const popup = document.createElement("div");
      popup.className = "popup"; popup.id = `popup-${id}`; popup.role = "dialog";
      popup.innerHTML = imgSrc ? `<img src="${imgSrc}" alt="">` : "";
      popup.addEventListener("click", e => e.stopPropagation());
      if (offsetX || offsetY) popup.style.transform = `translate(${offsetX}px, ${offsetY}px)`;

      viewer.addOverlay({ element: popup, location: new OpenSeadragon.Point(x, y), placement: OpenSeadragon.OverlayPlacement.BOTTOM });

      openPopupId = id;
      if (popupTimers.has(id)) clearTimeout(popupTimers.get(id));
      // Autoclose nur auf Touch, auf Desktop offen lassen bis Mouseleave
      if (!IS_POINTER_FINE){ const t = setTimeout(() => { closePopup(id); }, 10000); popupTimers.set(id, t); }
    }

    function closePopup(id){
      const el = document.getElementById(`popup-${id}`);
      if (el) el.remove();
      const dot = document.querySelector(`.hotspot-overlay[data-id="${CSS.escape(id)}"]`);
      if (dot) dot.classList.remove("is-hidden");
      if (popupTimers.has(id)) { clearTimeout(popupTimers.get(id)); popupTimers.delete(id); }
      if (openPopupId === id) openPopupId = null;
    }

    // XML laden (flexible Attribute wie mobil)
    function loadHotspots(xmlFile) {
      fetch(xmlFile)
        .then(r => r.text())
        .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
        .then(xml => {
          const nodes = xml.getElementsByTagName("HOTSPOT");
          for (let i = 0; i < nodes.length; i++) {
            const node = nodes[i];
            const x = parseFloat(node.getAttribute("X"));
            const y = parseFloat(node.getAttribute("Y"));
            const id = node.getAttribute("ID");

            const iconUrl = node.getAttribute("ICON") || node.getAttribute("ICONURL") || node.getAttribute("ICON_URL") || node.getAttribute("MARKER") || node.getAttribute("MEDIA") || "";
            const popupImage = node.getAttribute("POPUP") || node.getAttribute("POPUPIMG") || node.getAttribute("IMAGE") || "";
            const popupText = "";  // nur Bild
            const popupTitle = ""; // nur Bild
            const colorValue = node.getAttribute("COLOR") || node.getAttribute("COLOUR") || node.getAttribute("FARBE") || node.getAttribute("FILL") || node.getAttribute("BG") || node.getAttribute("DOTCOLOR") || null;
            const offsetX = parseInt(node.getAttribute("POPOFFSETX") || "0", 10);
            const offsetY = parseInt(node.getAttribute("POPOFFSETY") || "0", 10);

            addOverlay(x, y, id, iconUrl || ICON_DEFAULT, popupImage, popupText, popupTitle, colorValue, offsetX, offsetY);
          }
          applyHotspotScale();
        })
        .catch(err => console.error("Error loading XML:", err));
    }

    loadHotspots("./src/hotspots.xml");

    // Helper
    function focusOn(nx, ny, zoomFactor = 1.6){
      const ref = new OpenSeadragon.Point(nx, ny);
      viewer.viewport.panTo(ref, true);
      viewer.viewport.zoomBy(zoomFactor, ref, true);
    }

    window.addEventListener("orientationchange", () => setTimeout(applyHotspotScale, 50));
  </script>
</body>
</html>
