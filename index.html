<script>
  // ...
  const circleEl = document.getElementById('circle');

  // ✅ zentrale Helpers
  function isFullscreen() {
    return (document.fullscreenElement === circleEl) ||
           (document.webkitFullscreenElement === circleEl) ||  // iOS Safari
           document.body.classList.contains('pseudo-fs');
  }
  function supportsFullscreen(){
    return !!(circleEl.requestFullscreen || circleEl.webkitRequestFullscreen || circleEl.msRequestFullscreen);
  }
  function enterFullscreen(){
    if (circleEl.requestFullscreen) return circleEl.requestFullscreen();
    if (circleEl.webkitRequestFullscreen) return circleEl.webkitRequestFullscreen();
    if (circleEl.msRequestFullscreen) return circleEl.msRequestFullscreen();
  }
  function exitFullscreen(){
    if (document.exitFullscreen) return document.exitFullscreen();
    if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
    if (document.msExitFullscreen) return document.msExitFullscreen();
  }

  function setFullscreenClasses(isFs){
    circleEl.classList.toggle('is-fullscreen', isFs);
    if (!supportsFullscreen()){ document.body.classList.toggle('pseudo-fs', isFs); }
  }
  function updatePanBounds(isFs){
    if (isFs || document.body.classList.contains('pseudo-fs')){
      viewer.constrainDuringPan = false;
      viewer.viewport.setVisibilityRatio(0.2);
      viewer.minZoomImageRatio = 0.8;
    } else {
      viewer.constrainDuringPan = true;
      viewer.viewport.setVisibilityRatio(0.95);
      viewer.minZoomImageRatio = 1;
    }
  }

  // Events – benutze die Helpers
  document.addEventListener('fullscreenchange', () => {
    const fs = (document.fullscreenElement === circleEl);
    setFullscreenClasses(fs); updatePanBounds(fs); applyHotspotScale();
  });
  document.addEventListener('webkitfullscreenchange', () => {
    const fs = (document.webkitFullscreenElement === circleEl);
    setFullscreenClasses(fs); updatePanBounds(fs); applyHotspotScale();
  });

  async function ensureFullscreenIfNeeded(){
    if (isFullscreen()) return;
    if (supportsFullscreen()){
      return new Promise((resolve)=>{
        const onChange = ()=>{ document.removeEventListener('fullscreenchange', onChange); document.removeEventListener('webkitfullscreenchange', onChange); resolve(); };
        document.addEventListener('fullscreenchange', onChange);
        document.addEventListener('webkitfullscreenchange', onChange);
        enterFullscreen();
      });
    }
    setFullscreenClasses(true);
    updatePanBounds(true);
  }

  // Dein vorhandener Handler – nur die inFs-Abfrage ersetzen
  function hookOsdFullPageButton(){
    const root = viewer.container || document.getElementById('myContainer');
    if (!root) return;
    const btn = root.querySelector('.openseadragon-full-page, .openseadragon-full-screen, [title*="Full"], [title*="Voll"], [title*="page"]');
    if (!btn || btn.__pgHooked) return;
    btn.__pgHooked = true;

    const handler = (e)=>{
      e.preventDefault?.();
      e.stopPropagation?.();
      e.stopImmediatePropagation?.();

      if (isFullscreen()){
        if (supportsFullscreen()) exitFullscreen();
        else { setFullscreenClasses(false); updatePanBounds(false); }
      } else {
        ensureFullscreenIfNeeded();
      }
    };

    btn.addEventListener('click',     handler, { capture:true });
    btn.addEventListener('touchend',  handler, { capture:true, passive:false });
    btn.addEventListener('pointerup', handler, { capture:true });
  }

  // Auch hier überall isFullscreen() nutzen:
  const containerEl = document.getElementById('myContainer');
  containerEl.addEventListener('touchend', async (e)=>{
    if (e.touches && e.touches.length === 0){
      if (!isFullscreen()){ e.preventDefault(); await ensureFullscreenIfNeeded(); }
    }
  }, { passive: false });
  containerEl.addEventListener('click', async ()=>{
    if (!isFullscreen()){ await ensureFullscreenIfNeeded(); }
  });
  // ...
</script>
