<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Wimmelbild – Plan:g (Mobile + Vollbild)</title>
<link rel="icon" type="image/png" href="favicon.png" />
<script src="./openseadragon/openseadragon.min.js"></script>

<style>
  /* ========= Basis ========= */
  :root{
    --green:#789f40;
    --green-dark:#769b60;
    --accent:#870184;
    --bg:#f3f3f3;
    --pad: clamp(14px, 4vw, 20px);
  }
  *,*::before,*::after{ box-sizing:border-box; }
  html,body{ margin:0; background:var(--bg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#111; }
  a{ color:inherit; text-decoration:none; }

  /* ========= Header ========= */
  .m-header{ padding: calc(env(safe-area-inset-top) + 14px) var(--pad) 8px; }
  .m-header__logo{ width: clamp(150px, 48vw, 220px); height:auto; display:block; }

  .cta{ margin-top:10px; font-weight:700; text-transform:uppercase; font-size: clamp(13px, 3.7vw, 16px); background:var(--green); color:#fff; padding:12px 16px; border-radius:14px; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(0,0,0,.12); }
  .cta:active{ transform: scale(.98); }
  .m-ctas{ margin-top:12px; display:grid; gap:10px; max-width:360px; }

  /* ========= Headline ========= */
  .m-headline{ padding: 8px var(--pad) 0; }
  .m-headline h1{ margin:0; font-size: clamp(18px, 5.2vw, 22px); line-height:1.28; }

  /* ========= Kreis-Viewer ========= */
  .circle-wrap{ padding: 18px var(--pad) 6px; display:grid; place-items: center; }
  .circle{ width: min(86vw, 520px); aspect-ratio: 1 / 1; border-radius: 999px; clip-path: circle(50% at 50% 50%); background: var(--green-dark); overflow: hidden; position: relative; box-shadow: 0 8px 28px rgba(0,0,0,.18); }
  /* OpenSeadragon in Kreis */
  #myContainer{ position:absolute; inset:0; width:100%; height:100%; background:transparent; }

  /* ========= Vollbild-Modus ========= */
  .viewer-scrim{ position:fixed; inset:0; background:rgba(0,0,0,.38); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:1190; }
  .viewer-scrim.show{ opacity:1; pointer-events:auto; }
  .viewer-close{ position:fixed; top: max(12px, calc(env(safe-area-inset-top) + 8px)); right: max(12px, calc(env(safe-area-inset-right) + 8px)); z-index:1300; width:48px; height:48px; border:0; border-radius:999px; background:rgba(0,0,0,.62); color:#fff; font-size:26px; line-height:48px; text-align:center; cursor:pointer; opacity:0; pointer-events:none; transition:opacity .15s, transform .12s; backdrop-filter: blur(2px) saturate(120%); }
  .viewer-close.show{ opacity:1; pointer-events:auto; }
  .viewer-close:hover{ transform:scale(1.04); }
  .viewer-close:active{ transform:scale(.98); }

  /* Container wird im Vollbild aufgezogen */
  #myContainer.viewer-open{ position:fixed; inset:0; width:100vw; height:100vh; clip-path: none; border-radius:0; z-index:1200; background:#000; }

  /* UI im Vollbild ausblenden für bessere Sicht */
  body.viewer-mode .m-header,
  body.viewer-mode .m-headline,
  body.viewer-mode .m-footer{ display:none !important; }

  /* ========= Hotspots ========= */
  .hotspot-overlay{ width:22px; height:22px; background-size:contain; background-repeat:no-repeat; background-color:transparent; border:0; border-radius:999px; cursor:pointer; touch-action:manipulation; box-shadow:0 2px 6px rgba(0,0,0,.2); }

  /* Popups */
  .popup img{ display:block; max-width:90vw; height:auto; box-shadow:0 6px 24px rgba(0,0,0,.25); border-radius:12px; }
</style>
</head>

<body>
  <!-- Scrim & Close fürs Vollbild -->
  <div id="viewerScrim" class="viewer-scrim" aria-hidden="true"></div>
  <button id="viewerClose" class="viewer-close" aria-label="Schließen (Esc)" title="Schließen">✕</button>

  <!-- Header -->
  <header class="m-header">
    <img src="img/logo.png" alt="Plan:g – logo" class="m-header__logo" />
    <div class="m-ctas">
      <a href="https://plan-g.at/fachthemen/medizin-und-eza" target="_blank" rel="noopener" class="cta">Dieses Poster</a>
      <a href="https://plan-g.at/projekte/alle-projekte" target="_blank" rel="noopener" class="cta">Unsere Arbeit</a>
      <a href="https://plan-g.at/news-events/informiert-bleiben" target="_blank" rel="noopener" class="cta">Informiert bleiben</a>
    </div>
  </header>

  <!-- Headline -->
  <section class="m-headline">
    <h1>
      Die Welt ist ziemlich klein,<br />
      Gesundheit ziemlich komplex:<br />
      Viel Spaß beim Entdecken.
    </h1>
  </section>

  <!-- Wimmelbild als Kreis; Klick öffnet Vollbild -->
  <section class="circle-wrap" aria-label="Interaktives Wimmelbild">
    <div class="circle" id="circleFrame">
      <div id="myContainer" role="application" aria-label="Wimmelbild Viewer"></div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="m-footer">
    <div class="language">
      <a href="https://weltgesundheit.org" class="text-link" aria-label="Deutsch"><div class="flag de" title="Deutsch"></div></a>
      <a href="https://weltgesundheit.org/en/" class="text-link" aria-label="English"><div class="flag en" title="English"></div></a>
    </div>
    <p>Illustration: Alice Ruzzettu</p>
    <a href="http://plan-g.at/impressum" class="text-link" target="_blank" rel="noopener">Impressum</a>
  </footer>

<script>
  const IS_TOUCH = matchMedia('(pointer:coarse)').matches;
  // OpenSeadragon mit angenehmer Startansicht
  const viewer = OpenSeadragon({
    id: 'myContainer',
    prefixUrl: 'openseadragon/images/',
    tileSources: {
      type: 'image', width: 5787, height: 7722, url: './img/wimmelbildfinal.jpg',
      minLevel: 0, maxLevel: 5, buildPyramid: true
    },
    showNavigator: false,
    showNavigationControl: true,
    autoHideControls: true,
    blendTime: 0.12, animationTime: 0.85, springStiffness: 6.5,
    zoomPerClick: 1.22, zoomPerScroll: 1.14,
    visibilityRatio: 0.95, constrainDuringPan: true,
    minZoomImageRatio: 1, maxZoomPixelRatio: 2.0,
    maxImageCacheCount: 60, imageLoaderLimit: 2,
    immediateRender: true, preserveImageSizeOnResize: true
  });

  let HOME_Z = 1;
  const KEEP_CONSTANT_SIZE = true; // Punkte skalieren nicht mit

  viewer.addHandler('open', () => {
    viewer.viewport.goHome(true);
    viewer.viewport.fitVertically();
    HOME_Z = viewer.viewport.getZoom(true);
    setTimeout(() => {
      viewer.viewport.zoomTo(HOME_Z * 1.12, null, true); // angenehmes Startzoom
      if (KEEP_CONSTANT_SIZE) updateHotspotScale();
    }, 60);
  });

  // ===== Vollbildsteuerung =====
  const container = document.getElementById('myContainer');
  const circleFrame = document.getElementById('circleFrame');
  const scrim = document.getElementById('viewerScrim');
  const closeBtn = document.getElementById('viewerClose');

  function openViewer(){
    container.classList.add('viewer-open');
    document.body.classList.add('viewer-mode');
    scrim.classList.add('show');
    closeBtn.classList.add('show');
    document.body.style.overflow = 'hidden';
    try{ viewer.viewport.applyConstraints(); viewer.forceRedraw(); }catch(e){}
  }
  function closeViewer(){
    container.classList.remove('viewer-open');
    document.body.classList.remove('viewer-mode');
    scrim.classList.remove('show');
    closeBtn.classList.remove('show');
    document.body.style.overflow = '';
  }

  // Klick/Tap auf Kreis öffnet Vollbild
  viewer.addHandler('canvas-click', function(e){
    if(e.quick && !container.classList.contains('viewer-open')) openViewer();
  });
  scrim.addEventListener('click', closeViewer);
  closeBtn.addEventListener('click', closeViewer);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeViewer(); });

  // ===== Hotspots (aus XML) =====
  const SOURCE_W = 5787, SOURCE_H = 7722;
  const AUTHOR_W = 14344, AUTHOR_H = 19140;
  const Y_EXTRA_SCALE = 1.3348;

  function normalizeXY(xAuthor, yAuthor){
    const nx = (xAuthor * (SOURCE_W / AUTHOR_W)) / SOURCE_W;
    const ny = (yAuthor * (SOURCE_H / AUTHOR_H)) / SOURCE_H * Y_EXTRA_SCALE;
    return { nx, ny };
  }

  // kleinere, aber tappbare Punkte (konstante Größe)
  const BASE_SIZE = 22, MIN_SIZE = 18, MAX_SIZE = 28;
  function updateHotspotScale(){
    if (!KEEP_CONSTANT_SIZE) return;
    const z = viewer.viewport.getZoom(true);
    const size = Math.max(MIN_SIZE, Math.min(MAX_SIZE, BASE_SIZE * (HOME_Z / z)));
    document.querySelectorAll('.hotspot-overlay').forEach(el => {
      el.style.width = size + 'px';
      el.style.height = size + 'px';
      el.style.transformOrigin = 'center';
    });
  }
  viewer.addHandler('zoom', updateHotspotScale);
  viewer.addHandler('animation', updateHotspotScale);

  let openPopupId = null;

  function addOverlay(x, y, id, icon, popupImage){
    const { nx, ny } = normalizeXY(x, y);
    const overlay = document.createElement('button');
    overlay.className = 'hotspot-overlay';
    overlay.type = 'button';
    overlay.style.backgroundImage = `url(${icon})`;
    overlay.setAttribute('aria-label', 'Hotspot');
    overlay.setAttribute('data-id', id);

    overlay.addEventListener('click', (e) => {
      e.stopPropagation();
      if (openPopupId === id) closePopup(id);
      else togglePopup(id, nx, ny, popupImage);
    }, { passive:true });

    viewer.addOverlay({ element: overlay, location: new OpenSeadragon.Point(nx, ny), placement: OpenSeadragon.OverlayPlacement.CENTER });
  }

  function togglePopup(id, x, y, popupImage){
    const nodeId = `popup-${id}`;
    const existing = document.getElementById(nodeId);
    if(existing){ existing.remove(); openPopupId = null; return; }
    if(!popupImage) return;

    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.id = nodeId;
    popup.role = 'dialog';
    popup.innerHTML = `<img src="${popupImage}" alt="Hotspot Bild">`;

    viewer.addOverlay({ element: popup, location: new OpenSeadragon.Point(x, y), placement: OpenSeadragon.OverlayPlacement.BOTTOM });

    openPopupId = id;
    setTimeout(()=>document.getElementById(nodeId)?.remove(), 5000);
  }

  viewer.addHandler('canvas-click', function(){ if (openPopupId) { const id = openPopupId; openPopupId = null; const el = document.getElementById(`popup-${id}`); if(el) el.remove(); } });

  function loadHotspots(xmlFile){
    fetch(xmlFile)
      .then(r => r.text())
      .then(str => new window.DOMParser().parseFromString(str, 'text/xml'))
      .then(xml => {
        const nodes = xml.getElementsByTagName('HOTSPOT');
        for (let i=0; i<nodes.length; i++){
          const x = parseFloat(nodes[i].getAttribute('X'));
          const y = parseFloat(nodes[i].getAttribute('Y'));
          const id = nodes[i].getAttribute('ID');
          const icon = nodes[i].getAttribute('MEDIA') || './Assets/button-wim.png';
          const popupImage = nodes[i].getAttribute('POPUP');
          addOverlay(x, y, id, icon, popupImage);
        }
        updateHotspotScale();
      })
      .catch(err => console.error('Error loading XML:', err));
  }

  loadHotspots('./src/hotspots.xml');
</script>
</body>
</html>
