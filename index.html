<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Wimmelbild - Plan:g</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#769b60" />

  <script src="./openseadragon/openseadragon.min.js"></script>
  <script src="detect-browser.js"></script>
  <script>
    const info = (typeof getBrowser === "function" && getBrowser()) || {};
    if (["Microsoft Edge","Safari","Internet Explorer"].includes(info.browser)) {
      window.location = "index_ie.html";
    }
  </script>

  <style>
    @font-face{
      font-family:"circular";
      src:url("src/lineto-circular-book.woff") format("woff");
      font-weight:normal;
    }
    *{box-sizing:border-box;margin:0;padding:0}

    html,body{height:100%}
    body{
      font-family:"circular",Arial,sans-serif;
      background:#f3f3f3;
      color:#000;
      /* Safe-Area für iOS-Notch etc. */
      padding:
        max(env(safe-area-inset-top),0px)
        max(env(safe-area-inset-right),0px)
        max(env(safe-area-inset-bottom),0px)
        max(env(safe-area-inset-left),0px);
    }

    /* ===== Mobile Einspalten-Layout ===== */
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:20px;
    }

    /* HEADER (Logo + Claim + Buttons) */
    .header{
      padding:24px 20px 0 20px;
      max-width:720px;   /* schöne Linienlänge */
    }
    .logo{ width:200px; height:auto; margin-bottom:14px; }
    .claim{ font-size:22px; line-height:1.28; }

    .ctas{ display:flex; flex-wrap:wrap; gap:10px; margin-top:16px; }
    .cta{
      background:#789f40; color:#fff; text-decoration:none;
      text-transform:uppercase; font-weight:bold; font-size:14px;
      padding:12px 14px; border-radius:2px;
      display:flex; align-items:center; justify-content:center;
    }
    .cta:active,.cta:hover{ background:#870184; }

    /* KREIS-VIEWER mittig darunter */
    .circle-wrap{
      display:flex;
      justify-content:center;
      align-items:center;
      width:100%;
      padding:8px 0 0 0;
    }
    /* Der Kreis ist responsiv, bleibt immer 1:1 und zentriert */
    #myContainer{
      width: min(92vw, 720px);
      aspect-ratio: 1 / 1;
      background:#769b60;
      clip-path: circle(50% at 50% 50%);
      -webkit-clip-path: circle(50% at 50% 50%);
      overflow:hidden;
    }

    /* FOOTER unten links */
    .footer{
      margin-top:auto;                /* drückt Footer nach unten */
      padding: 6px 20px 18px 20px;
      max-width:720px;
    }
    .language{ display:flex; gap:14px; margin-bottom:6px; }
    .flag{ width:28px; height:20px; background-size:cover; }
    .flag.de{ background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/at.svg"); }
    .flag.en{ background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/gb.svg"); }
    .text-link{ color:#789f40; text-decoration:none; font-size:12px; }
    .credit{ font-size:12px; color:#000; margin:2px 0 4px 0; }

    /* Hotspots & Popup */
    .hotspot-overlay{
      width:14px;height:14px;border-radius:50%;
      background-size:cover;background-repeat:no-repeat;
      box-shadow:0 2px 4px rgba(0,0,0,.3);
    }
    .popup{
      max-width:90vw; max-height:60vh; overflow:hidden;
      border-radius:8px; background:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.3);
    }
    .popup img{ display:block; width:100%; height:auto; }

    /* etwas großzügiger auf sehr großen Phones/Tablets */
    @media (min-width: 820px){
      .logo{ width:240px }
      .claim{ font-size:24px }
      .cta{ font-size:15px; padding:13px 16px }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- oben links -->
    <header class="header">
      <a href="https://plan-g.at/ueber-uns" target="_blank" aria-label="Über uns">
        <img src="img/logo.png" class="logo" alt="plan:g">
      </a>
      <h1 class="claim">
        Die Welt ist ziemlich klein,<br>
        Gesundheit ziemlich komplex:<br>
        Viel Spaß beim Entdecken.
      </h1>
      <nav class="ctas" aria-label="Hauptaktionen">
        <a class="cta" href="https://plan-g.at/fachthemen/medizin-und-eza" target="_blank">Dieses Poster</a>
        <a class="cta" href="https://plan-g.at/projekte/alle-projekte" target="_blank">Unsere Arbeit</a>
        <a class="cta" href="https://plan-g.at/news-events/informiert-bleiben" target="_blank">Informiert bleiben</a>
      </nav>
    </header>

    <!-- dann der Kreis -->
    <main class="circle-wrap">
      <div id="myContainer"></div>
    </main>

    <!-- unten links -->
    <footer class="footer">
      <div class="language" aria-label="Sprachen">
        <a href="https://weltgesundheit.org" class="text-link" title="Deutsch"><div class="flag de"></div></a>
        <a href="https://weltgesundheit.org/en/" class="text-link" title="English"><div class="flag en"></div></a>
      </div>
      <p class="credit">Illustration: Alice Ruzzettu</p>
      <a href="http://plan-g.at/impressum" target="_blank" class="text-link">Impressum</a>
    </footer>
  </div>

  <script>
    /* ===== OpenSeadragon – passt sich automatisch der Kreisgröße an ===== */
    const viewer = OpenSeadragon({
      id: "myContainer",
      prefixUrl: "openseadragon/images/",
      tileSources: {
        type: "image",
        width: 5787,
        height: 7722,
        url: "./img/wimmelbildfinal.jpg",
        minLevel: 0,
        maxLevel: 5,
        buildPyramid: true
      },
      showNavigator: false,
      showNavigationControl: false,
      defaultZoomLevel: 0,
      gestureSettingsMouse: { clickToZoom:true, dblClickToZoom:true, pinchToZoom:true },
      gestureSettingsTouch: { clickToZoom:true, dblClickToZoom:true, pinchToZoom:true },
      constrainDuringPan: true,
      maxZoomPixelRatio: 2,
      minZoomImageRatio: 0.5,
      maxZoomImageRatio: 3
    });

    // Start: Kreis gut füllen
    viewer.addHandler('open', () => {
      viewer.viewport.fitVertically();
      setTimeout(() => viewer.viewport.zoomBy(1.06), 60);
    });

    // Bei Größenänderung: neu zeichnen
    const ro = new ResizeObserver(() => viewer && viewer.forceRedraw());
    ro.observe(document.getElementById('myContainer'));

    /* ===== Hotspots laden ===== */
    function loadHotspots(xmlFile){
      fetch(xmlFile)
        .then(r => r.text())
        .then(str => (new DOMParser()).parseFromString(str, "text/xml"))
        .then(xml => {
          const spots = xml.getElementsByTagName("HOTSPOT");
          for (let i=0;i<spots.length;i++){
            const x = parseFloat(spots[i].getAttribute("X"));
            const y = parseFloat(spots[i].getAttribute("Y"));
            const id = spots[i].getAttribute("ID");
            const popupImage = spots[i].getAttribute("POPUP");
            addOverlay(x, y, id, "./Assets/button-wim.png", popupImage);
          }
        })
        .catch(err => console.error("Error loading XML:", err));
    }

    function addOverlay(x, y, id, icon, popupImage){
      const normalizedX = (x * (5787 / 14344)) / 5787;
      const normalizedY = (y * (7722 / 19140)) / 7722 * 1.3348;

      const el = document.createElement("div");
      el.className = "hotspot-overlay";
      el.style.backgroundImage = `url(${icon})`;

      const handler = (e) => { e.preventDefault(); togglePopup(id, normalizedX, normalizedY, popupImage); };
      el.addEventListener('touchstart', handler, { passive:false });
      el.addEventListener('click', handler);

      viewer.addOverlay({
        element: el,
        location: new OpenSeadragon.Point(normalizedX, normalizedY),
        placement: OpenSeadragon.OverlayPlacement.CENTER
      });
    }

    function togglePopup(id, x, y, popupImage){
      const ex = document.getElementById(`popup-${id}`);
      if (ex){ ex.remove(); return; }

      const popup = document.createElement("div");
      popup.className = "popup";
      popup.id = `popup-${id}`;
      popup.innerHTML = `<img src="${popupImage}" alt="Popup ${id}">`;

      viewer.addOverlay({
        element: popup,
        location: new OpenSeadragon.Point(x, y),
        placement: OpenSeadragon.OverlayPlacement.BOTTOM
      });

      setTimeout(() => document.getElementById(`popup-${id}`)?.remove(), 5000);
    }

    loadHotspots("./src/hotspots.xml");
  </script>
</body>
</html>
