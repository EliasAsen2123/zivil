<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Wimmelbild - Plan:g</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#769b60" />

  <script src="./openseadragon/openseadragon.min.js"></script>
  <script src="detect-browser.js"></script>
  <script>
    const info = getBrowser();
    if (info.browser === "Microsoft Edge" || info.browser === "Safari" || info.browser === "Internet Explorer") {
      window.location = "index_ie.html";
    }
  </script>

  <style>
    @font-face {
      font-family: "circular";
      src: url("src/lineto-circular-book.woff") format("woff");
      font-weight: normal;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    html, body { height:100%; }
    body {
      font-family: "circular", Arial, sans-serif;
      background:#f3f3f3;
      overflow:hidden;  /* wie Desktop */
    }

    /* --- Layout wie Desktop (auch auf Handy) --- */
    .page {
      position:relative;
      height:100vh;
      width:100vw;
    }

    /* Linke Spalte: Logo + Claim + Buttons */
    .welcome {
      position:absolute;
      z-index:250;
      top:51px;
      left:22px;
      width:min(72vw, 480px);
    }
    .logo { width:220px; padding-bottom:24px; }
    .welcomeMessage { margin-top:16px; font-size:22px; line-height:1.35; }
    .flexcta { width:100%; padding-top:36px; display:flex; flex-wrap:wrap; gap:12px; }
    .cta {
      max-width:230px; background:#789f40; color:#fff; text-decoration:none;
      text-transform:uppercase; font-weight:bold; font-size:16px;
      padding:14px; display:flex; align-items:center; justify-content:center;
      transition:background-color .3s;
    }
    .cta:active, .cta:hover { background:#870184; }

    /* Impressum + Sprachen unten links */
    .impressum {
      position:absolute; bottom:18px; left:22px; z-index:260;
      font-size:14px; line-height:1.4;
    }
    .language { display:flex; gap:14px; margin-bottom:8px; }
    .flag { width:28px; height:20px; background-size:cover; }
    .flag.de { background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/at.svg"); }
    .flag.en { background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/gb.svg"); }
    .text-link { color:#789f40; text-decoration:none; }

    /* Rechte Seite: runder Viewer wie am Desktop */
    #myContainer {
      position:absolute;
      top:50%;
      right: clamp(16px, 8vw, 80px);
      transform: translateY(-50%);
      width: clamp(260px, 86vw, 820px);
      height: clamp(260px, 86vw, 820px);
      background:#769b60;
      /* fester Kreis (auf Handy kein Hover) */
      clip-path: circle(50% at 50% 50%);
      -webkit-clip-path: circle(50% at 50% 50%);
      z-index:500;
      overflow:hidden;
    }

    /* Hotspots */
    .hotspot-overlay {
      width:14px; height:14px;
      background-size:cover; background-repeat:no-repeat;
      border-radius:50%;
      box-shadow:0 2px 4px rgba(0,0,0,.3);
    }

    /* Popups */
    .popup {
      max-width:80vw; max-height:60vh; overflow:hidden; border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.3); background:#fff;
    }
    .popup img { width:100%; height:auto; display:block; }

    /* sehr kleine Geräte etwas kompakter */
    @media (max-width: 380px) {
      .logo { width:190px; }
      .welcomeMessage { font-size:20px; }
      .cta { font-size:14px; padding:12px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Kreis-Viewer rechts -->
    <div id="myContainer"></div>

    <!-- Linke Inhalte wie Desktop -->
    <div class="welcome">
      <a href="https://plan-g.at/ueber-uns" target="_blank"><img src="img/logo.png" class="logo" alt="plan:g"/></a>
      <h1 class="welcomeMessage">
        Die Welt ist ziemlich klein,<br/>
        Gesundheit ziemlich komplex:<br/>
        Viel Spaß beim Entdecken.
      </h1>
      <div class="flexcta">
        <a class="cta" href="https://plan-g.at/fachthemen/medizin-und-eza" target="_blank">Dieses Poster</a>
        <a class="cta" href="https://plan-g.at/projekte/alle-projekte" target="_blank">Unsere Arbeit</a>
        <a class="cta" href="https://plan-g.at/news-events/informiert-bleiben" target="_blank">Informiert bleiben</a>
      </div>
    </div>

    <div class="impressum">
      <div class="language">
        <a href="https://weltgesundheit.org" class="text-link" title="Deutsch"><div class="flag de"></div></a>
        <a href="https://weltgesundheit.org/en/" class="text-link" title="English"><div class="flag en"></div></a>
      </div>
      <p>Illustration: Alice Ruzzettu</p>
      <a href="http://plan-g.at/impressum" target="_blank" class="text-link">Impressum</a>
    </div>
  </div>

  <script>
    // OpenSeadragon – mobil reduziert, ohne UI-Controls
    const viewer = OpenSeadragon({
      id: "myContainer",
      prefixUrl: "openseadragon/images/",
      tileSources: {
        type: "image",
        width: 5787,
        height: 7722,
        url: "./img/wimmelbildfinal.jpg",
        minLevel: 0,
        maxLevel: 5,
        buildPyramid: true
      },
      showNavigator: false,
      showNavigationControl: false,
      defaultZoomLevel: 0,
      gestureSettingsMouse: { clickToZoom:true, dblClickToZoom:true, pinchToZoom:true },
      gestureSettingsTouch: { clickToZoom:true, dblClickToZoom:true, pinchToZoom:true },
      constrainDuringPan: true,
      maxZoomPixelRatio: 2,
      minZoomImageRatio: 0.5,
      maxZoomImageRatio: 3
    });

    // Beim Öffnen Bild einpassen (kreisfläche möglichst füllen)
    viewer.addHandler('open', () => {
      // leichter Zoom, damit keine weißen Ränder im Kreis
      viewer.viewport.fitVertically();
      setTimeout(() => viewer.viewport.zoomBy(1.05), 60);
    });

    // --- Hotspots laden ---
    function loadHotspots(xmlFile) {
      fetch(xmlFile)
        .then(r => r.text())
        .then(str => new DOMParser().parseFromString(str, "text/xml"))
        .then(xml => {
          const hs = xml.getElementsByTagName("HOTSPOT");
          for (let i = 0; i < hs.length; i++) {
            const x = parseFloat(hs[i].getAttribute("X"));
            const y = parseFloat(hs[i].getAttribute("Y"));
            const id = hs[i].getAttribute("ID");
            const popupImage = hs[i].getAttribute("POPUP");
            addOverlay(x, y, id, "./Assets/button-wim.png", popupImage);
          }
        })
        .catch(err => console.error("Error loading XML:", err));
    }

    // --- FIX: Overlay wurde in deiner Mobile-Version nicht hinzugefügt ---
    function addOverlay(x, y, id, icon, popupImage) {
      const normalizedX = (x * (5787 / 14344)) / 5787;
      const normalizedY = (y * (7722 / 19140)) / 7722 * 1.3348;

      const el = document.createElement("div");
      el.className = "hotspot-overlay";
      el.style.backgroundImage = `url(${icon})`;

      // Touch + Click
      const handler = (e) => {
        e.preventDefault();
        togglePopup(id, normalizedX, normalizedY, popupImage);
      };
      el.addEventListener('touchstart', handler, { passive:false });
      el.addEventListener('click', handler);

      // >>> tatsächlich zum Viewer hinzufügen
      viewer.addOverlay({
        element: el,
        location: new OpenSeadragon.Point(normalizedX, normalizedY),
        placement: OpenSeadragon.OverlayPlacement.CENTER
      });
    }

    function togglePopup(id, x, y, popupImage) {
      const existing = document.getElementById(`popup-${id}`);
      if (existing) {
        existing.remove();
        return;
      }
      const popup = document.createElement("div");
      popup.className = "popup";
      popup.id = `popup-${id}`;
      popup.innerHTML = `<img src="${popupImage}" alt="Popup ${id}">`;

      viewer.addOverlay({
        element: popup,
        location: new OpenSeadragon.Point(x, y),
        placement: OpenSeadragon.OverlayPlacement.BOTTOM
      });

      // Auto-close nach 5s
      setTimeout(() => document.getElementById(`popup-${id}`)?.remove(), 5000);
    }

    loadHotspots("./src/hotspots.xml");
  </script>
</body>
</html>
