<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <title>Wimmelbild - Plan:g</title>
  <link rel="icon" type="image/png" href="../favicon.png" />

  <!-- libs -->
  <script src="../openseadragon/openseadragon.min.js"></script>
  <script src="../detect-browser.js"></script>

  <script>
    // Browser-Fallback (aus /en eine Ebene raus)
    (function () {
      var info = getBrowser ? getBrowser() : {};
      if (info.browser === "Microsoft Edge" || info.browser === "Safari" || info.browser === "Internet Explorer") {
        window.location = "../index_ie.html";
      }
    })();
  </script>

  <style>
    @font-face {
      font-family: "circular";
      src: url("../src/lineto-circular-book.woff") format("woff");
      font-weight: normal;
    }
    * { margin:0; padding:0; }
    html, body { height:100%; }
    body { position:relative; overflow:hidden; background:#f3f3f3; }

    #myContainer{
      width:100%;
      height:100vh;
      background:#769b60;
      -webkit-clip-path: circle(20vw at center);
               clip-path: circle(20vw at center);
      -webkit-transition:left 900ms, -webkit-clip-path 900ms;
      transition:left 900ms, clip-path 900ms, -webkit-clip-path 900ms;
      position:absolute; left:10vw; z-index:500;
    }
    #myContainer:hover{ -webkit-clip-path:circle(100vw at center); clip-path:circle(100vw at center); left:0; }

    .logo-container{ position:absolute; z-index:1000; top:25px; left:25px; opacity:0; display:none; transition:opacity 900ms; }
    .logo{ width:250px; padding-bottom:30px; }
    .signet{ width:100px; }

    .welcome{ position:absolute; z-index:250; top:51px; left:22px; width:70%; }
    .welcomeMessage{ font-family:"circular"; margin-top:20px; }
    .flexcta{ width:60%; padding-top:60px; }
    .cta{
      font-family:"circular"; max-width:230px; background:#789f40; padding:15px; color:#fff;
      text-decoration:none; display:flex; align-items:center; justify-content:center;
      text-transform:uppercase; font-weight:bold; font-size:18px; transition:background-color 600ms; margin:20px 0 0;
    }
    .cta:hover{ background:#870184; }
    .link{ text-decoration:none; }
    .text-link{ color:#789f40; }

    .impressum{ position:absolute; bottom:20px; left:22px; font-family:"circular"; z-index:260; font-size:18px; line-height:1.5; }
    .language{ display:flex; width:80px; height:50px; justify-content:space-between; font-size:14px; }
    .flag-container{ text-align:center; margin:10px 0; }
    .flag{ width:30px; height:22px; background-size:cover; margin:10px auto; }
    .flag.en{ background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/gb.svg"); }
    .flag.de{ background-image:url("https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/flags/4x3/at.svg"); }

    /* >>> wichtig: sichtbare Buttons */
    .hotspot-overlay{
      width:24px;
      height:24px;
      background-image:url("../Assets/button-wim.png"); /* Icon aus /en heraus */
      background-repeat:no-repeat;
      background-size:contain;
      position:absolute;   /* OSD positioniert absolut */
      z-index:9999;
      cursor:pointer;
      pointer-events:auto;
    }

    .popup img{ display:block; max-width:400px; height:auto; }
  </style>

  <!-- Matomo -->
  <script>
    var _paq = window._paq || [];
    _paq.push(["trackPageView"]);
    _paq.push(["enableLinkTracking"]);
    (function () {
      var u = "https://www.plan-g.at/sub/piwik/";
      _paq.push(["setTrackerUrl", u + "piwik.php"]);
      _paq.push(["setSiteId", "4"]);
      var d = document, g = d.createElement("script"), s = d.getElementsByTagName("script")[0];
      g.type = "text/javascript"; g.async = true; g.defer = true; g.src = u + "piwik.js"; s.parentNode.insertBefore(g, s);
    })();
  </script>
  <!-- End Matomo -->
</head>
<body>
  <div id="myContainer"></div>

  <script>
    // ========= Konfiguration =========
    // Größe des großen Layouts, aus dem die XML-Koordinaten stammen.
    // Wenn deine XML andere Basiswerte nutzt, hier anpassen:
    const XML_BASE_WIDTH  = 14344;
    const XML_BASE_HEIGHT = 19140;

    // Quelle des Deep-Zoom-Bilds (aus /en eine Ebene raus)
    const TILE_SOURCE = {
      type: "image",
      width: 5787,
      height: 7722,
      url: "../img/wimmelbildfinal.jpg",
      minLevel: 0,
      maxLevel: 5,
      buildPyramid: true
    };

    // ========= Viewer =========
    const viewer = OpenSeadragon({
      id: "myContainer",
      prefixUrl: "../openseadragon/images/",
      tileSources: TILE_SOURCE,
      showNavigator: true,
      navigatorPosition: "TOP_RIGHT",
      defaultZoomLevel: 0,
      showNavigationControl: true
    });

    // Popup-Pfad auf Englisch umbiegen und aus /en herausziehen
    function toEnPopupPath(p){
      if(!p) return "";
      return "../" + String(p)
        .replace(/^\.\//,"")
        .replace(/Assets\/popups(-en)?\//, "Assets/popups-en/");
    }

    function loadHotspots(xmlFile){
      fetch(xmlFile)
        .then(r => r.text())
        .then(t => new DOMParser().parseFromString(t, "text/xml"))
        .then(xml => {
          const nodes = Array.from(xml.getElementsByTagName("HOTSPOT"));
          console.log("Hotspots loaded:", nodes.length);
          nodes.forEach(n => {
            const x  = parseFloat(n.getAttribute("X")); // aus XML
            const y  = parseFloat(n.getAttribute("Y"));
            const id = n.getAttribute("ID");
            const popupImg = toEnPopupPath(n.getAttribute("POPUP"));

            addOverlay(x, y, id, popupImg);
          });
        })
        .catch(err => console.error("XML load error:", err));
    }

    function addOverlay(x, y, id, popupImage){
      // In Normalisierungskoordinaten (0..1) umrechnen – basierend auf XML-Basisgröße:
      const normX = x / XML_BASE_WIDTH;
      const normY = y / XML_BASE_HEIGHT;

      const el = document.createElement("div");
      el.className = "hotspot-overlay";
      el.setAttribute("data-id", id);

      el.addEventListener("mouseenter", () => togglePopup(id, normX, normY, popupImage, true));
      el.addEventListener("mouseleave", () => togglePopup(id, normX, normY, popupImage, false));

      viewer.addOverlay({
        element: el,
        location: new OpenSeadragon.Point(normX, normY),
        placement: OpenSeadragon.OverlayPlacement.CENTER
      });
    }

    function togglePopup(id, x, y, popupImage, show){
      const existing = document.getElementById("popup-"+id);
      if (show) {
        if (existing) return;
        const wrap = document.createElement("div");
        wrap.className = "popup";
        wrap.id = "popup-" + id;
        wrap.innerHTML = `<img src="${popupImage}" alt="">`;
        viewer.addOverlay({
          element: wrap,
          location: new OpenSeadragon.Point(x, y),
          placement: OpenSeadragon.OverlayPlacement.BOTTOM
        });
      } else {
        if (existing) existing.remove();
      }
    }

    // aus /en eine Ebene raus zum XML
    loadHotspots("../src/hotspots.xml"); // oder "../src/hotspots-en.xml" falls du eine eigene EN-XML nutzt
  </script>

  <div class="logo-container">
    <a href="https://plan-g.at/ueber-uns" target="_blank">
      <img src="../img/signet_bunt.png" class="signet" alt="">
    </a>
  </div>

  <div class="welcome">
    <a href="https://plan-g.at/ueber-uns" target="_blank">
      <img src="../img/logo.png" class="logo" alt="Plan:g">
    </a>
    <h1 class="welcomeMessage">
      The world is pretty small,<br/>
      health is pretty complex:<br/>
      Enjoy exploring.
    </h1>
    <div class="flexcta">
      <a href="https://plan-g.at/fachthemen/medizin-und-eza" target="_blank" class="link"><div class="cta">This poster</div></a>
      <a href="https://plan-g.at/projekte/alle-projekte" target="_blank" class="link"><div class="cta">Our work</div></a>
      <a href="https://plan-g.at/news-events/informiert-bleiben" target="_blank" class="link"><div class="cta">Stay informed</div></a>
    </div>
  </div>

  <div class="impressum">
    <div class="language">
      <div class="flag-container">
        <a href="https://weltgesundheit.org" class="text-link"><div class="flag de"></div></a>
      </div>
      <div class="flag-container">
        <a href="https://weltgesundheit.org/en/" class="text-link"><div class="flag en"></div></a>
      </div>
    </div>
    <p>Illustration: Alice Ruzzettu</p>
    <a href="http://plan-g.at/impressum" class="text-link" target="_blank">Imprint</a>
  </div>
</body>
</html>
